# i18n 國際化功能設計

**日期：** 2026-02-13
**狀態：** 已實作

## Context

Movie Picker 目前所有 UI 文字都是繁體中文硬編碼。為了展現專業的國際化能力，以及讓專案可以服務英語使用者，需要加入 i18n（國際化）支援。

**需求背景：**
- 專案定位為 Portfolio 作品，需展現業界標準實踐
- 支援繁體中文和英文雙語切換
- 不僅 UI 文字，連 TMDB API 的電影資料也要根據語言切換

## 設計決策

### 技術選型：react-i18next

**選擇 react-i18next 的理由：**
1. ✅ 最流行的 React i18n 解決方案，展現對業界標準的掌握
2. ✅ TypeScript 支援良好，可實現類型安全的翻譯 keys
3. ✅ 內建 React hooks（`useTranslation`），使用簡潔
4. ✅ 支援 namespace 分割翻譯檔案，易於維護大型專案
5. ✅ 與現有 Zustand 架構整合容易
6. ✅ Bundle size 合理（10-12KB gzipped），可接受

**替代方案對比：**
- **react-intl**: 功能過於複雜，bundle size 更大（15-20KB），對本專案需求而言 overkill
- **自訂方案**: 最輕量但缺少進階功能，不利於展現專業度

### 語言切換方式

**Header 語言切換按鈕（下拉選單）**

**設計：**
- 位置：Header 右側，使用者登入按鈕旁
- UI：使用 shadcn/ui 的 DropdownMenu 組件
- 顯示：當前語言名稱 + Languages icon
- 選項：繁體中文 / English

**理由：**
- ✅ 符合主流網站的 UX 慣例
- ✅ 清楚顯示當前語言
- ✅ 易於擴充（未來如需加第三種語言）

### 語言持久化

**使用 localStorage**

儲存 key: `language`
可能值: `'zh-TW'` | `'en'`

**理由：**
- ✅ 實作簡單，無需登入即可使用
- ✅ 即時生效，無需額外請求
- ❌ 缺點：不同裝置不同步（但對 Portfolio 展示專案來說可接受）

### TMDB API 語言支援

**電影資料也要翻譯**

當語言切換為英文時，TMDB API 請求參數也切換為 `language=en-US`，取得英文的電影標題、簡介等資料。

**語言映射：**
```
'zh-TW' → TMDB 'zh-TW'
'en'    → TMDB 'en-US'
```

**實作機制：**
- 在 React Query 的 `queryKey` 中加入 `language` 參數
- 語言切換時，queryKey 改變，自動觸發重新請求
- 利用 React Query 的快取機制，不同語言的資料分別快取

### 預設語言

**繁體中文（zh-TW）**

符合目前專案內容的主要語言。

## 整體架構設計

### 三層架構

```
┌─────────────────────────────────────────┐
│  React Components                        │
│  (使用 useTranslation hook)              │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│  Zustand Store (languageStore)          │
│  - 統一管理語言狀態                       │
│  - 觸發 TMDB API 重新請求                │
│  - 處理 localStorage 持久化              │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│  i18next                                 │
│  - 翻譯邏輯                              │
│  - 語言切換                              │
│  - 翻譯資源儲存                          │
└─────────────────────────────────────────┘
```

**為什麼這樣設計？**
- ✅ 保持與現有 Zustand 架構一致（專案已使用 authStore, wishlistStore 等）
- ✅ 集中管理語言狀態（Single Source of Truth）
- ✅ TMDB API hooks 可以輕鬆訂閱 language 變更
- ✅ 各層職責清晰，易於測試

### 語言切換完整流程

```
使用者點擊語言下拉選單，選擇 "English"
    ↓
languageStore.setLanguage('en')
    ↓
├─→ i18next.changeLanguage('en')             (UI 文字立即切換)
├─→ localStorage.setItem('language', 'en')   (持久化儲存)
└─→ Zustand 觸發 re-render
    ↓
所有使用 useMovies() 的組件重新執行
    ↓
React Query 發現 queryKey 改變
(舊: ['movies', 'popular', 'zh-TW'])
(新: ['movies', 'popular', 'en'])
    ↓
自動重新請求電影資料 (language=en-US)
    ↓
UI 更新為英文電影標題和簡介
```

## 檔案結構

```
src/
├── i18n/
│   ├── config.ts              # i18next 初始化設定
│   ├── locales/
│   │   ├── zh-TW.json         # 繁體中文翻譯
│   │   └── en.json            # 英文翻譯
│   └── types.ts               # TypeScript 類型定義
├── stores/
│   └── languageStore.ts       # Zustand 語言狀態管理
└── hooks/
    └── useLanguage.ts         # 自訂 hook（可選，封裝常用邏輯）
```

## 實作細節

### 1. i18next 配置

**src/i18n/config.ts**

```typescript
import i18n from 'i18next'
import { initReactI18next } from 'react-i18next'
import zhTW from './locales/zh-TW.json'
import en from './locales/en.json'

i18n
  .use(initReactI18next)
  .init({
    resources: {
      'zh-TW': { translation: zhTW },
      'en': { translation: en }
    },
    lng: localStorage.getItem('language') || 'zh-TW',
    fallbackLng: 'zh-TW',
    interpolation: {
      escapeValue: false  // React 已經防 XSS
    }
  })

export default i18n
```

### 2. Zustand Store

**src/stores/languageStore.ts**

```typescript
import { create } from 'zustand'
import i18n from '@/i18n/config'

type Language = 'zh-TW' | 'en'

interface LanguageStore {
  language: Language
  setLanguage: (lang: Language) => void
}

export const useLanguageStore = create<LanguageStore>((set) => ({
  language: (localStorage.getItem('language') as Language) || 'zh-TW',

  setLanguage: (lang) => {
    set({ language: lang })
    localStorage.setItem('language', lang)
    i18n.changeLanguage(lang)
  }
}))
```

### 3. 翻譯檔案結構

**使用 namespace 分類組織：**

```json
// src/i18n/locales/zh-TW.json
{
  "common": {
    "appName": "Movie Picker",
    "search": "搜尋電影...",
    "login": "登入",
    "logout": "登出",
    "user": "使用者"
  },
  "nav": {
    "home": "首頁",
    "top100": "Top 100",
    "random": "隨機挑片",
    "wishlist": "收藏清單"
  },
  "home": {
    "hero": {
      "title": "發現你的下一部經典電影",
      "subtitle": "從熱門大片到經典佳作，讓我們幫你找到完美的觀影選擇。智能推薦系統與隨機挑片功能，解決你的選擇困難。",
      "ctaRandom": "開始隨機挑片",
      "ctaTop100": "瀏覽 TOP 100"
    },
    "sections": {
      "trending": "本週趨勢",
      "popular": "熱門電影",
      "topRated": "高評分電影",
      "viewAll": "查看完整 TOP 100"
    }
  },
  "errors": {
    "loadFailed": "載入失敗，請稍後再試"
  }
}
```

```json
// src/i18n/locales/en.json
{
  "common": {
    "appName": "Movie Picker",
    "search": "Search movies...",
    "login": "Login",
    "logout": "Logout",
    "user": "User"
  },
  "nav": {
    "home": "Home",
    "top100": "Top 100",
    "random": "Random Pick",
    "wishlist": "Wishlist"
  },
  "home": {
    "hero": {
      "title": "Discover Your Next Classic Movie",
      "subtitle": "From blockbusters to classics, let us help you find the perfect movie. Smart recommendations and random picks to solve your choice paralysis.",
      "ctaRandom": "Start Random Pick",
      "ctaTop100": "Browse TOP 100"
    },
    "sections": {
      "trending": "Trending This Week",
      "popular": "Popular Movies",
      "topRated": "Top Rated Movies",
      "viewAll": "View Full TOP 100"
    }
  },
  "errors": {
    "loadFailed": "Failed to load, please try again later"
  }
}
```

### 4. 組件使用方式

**Before:**
```tsx
<h1>發現你的下一部經典電影</h1>
<Button>開始隨機挑片</Button>
```

**After:**
```tsx
const { t } = useTranslation()

<h1>{t('home.hero.title')}</h1>
<Button>{t('home.hero.ctaRandom')}</Button>
```

### 5. Header 語言切換組件

**src/components/layout/Header.tsx (新增)**

```tsx
import { Languages } from 'lucide-react'
import { useLanguageStore } from '@/stores/languageStore'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { Button } from '@/components/ui/button'

// 在 Header 組件中加入：
const { language, setLanguage } = useLanguageStore()

<DropdownMenu>
  <DropdownMenuTrigger asChild>
    <Button variant="ghost" size="sm">
      <Languages className="size-4" />
      <span className="hidden sm:inline">
        {language === 'zh-TW' ? '繁體中文' : 'English'}
      </span>
    </Button>
  </DropdownMenuTrigger>
  <DropdownMenuContent>
    <DropdownMenuItem onClick={() => setLanguage('zh-TW')}>
      繁體中文
    </DropdownMenuItem>
    <DropdownMenuItem onClick={() => setLanguage('en')}>
      English
    </DropdownMenuItem>
  </DropdownMenuContent>
</DropdownMenu>
```

### 6. TMDB API 整合

**語言映射常數：**

```typescript
// src/utils/constants.ts
export const TMDB_LANGUAGE_MAP = {
  'zh-TW': 'zh-TW',
  'en': 'en-US'
} as const
```

**修改 useMovies hook：**

```typescript
// src/hooks/useMovies.ts
import { useLanguageStore } from '@/stores/languageStore'
import { TMDB_LANGUAGE_MAP } from '@/utils/constants'

export function useMovies(category: string) {
  const language = useLanguageStore(state => state.language)

  return useQuery({
    queryKey: ['movies', category, language],  // ✅ 加入 language
    queryFn: () => fetchMovies(category, TMDB_LANGUAGE_MAP[language]),
    keepPreviousData: true,  // 切換時先顯示舊資料
  })
}
```

**修改 API 服務：**

```typescript
// src/services/tmdb.ts
export async function fetchMovies(
  category: string,
  language: string = 'zh-TW'
) {
  const response = await axios.get(`${TMDB_BASE_URL}/movie/${category}`, {
    params: {
      api_key: TMDB_API_KEY,
      language: language,  // ✅ 動態語言參數
      page: 1
    }
  })
  return response.data
}
```

### 7. Provider 設定

**src/app/providers.tsx**

```tsx
import { I18nextProvider } from 'react-i18next'
import i18n from '@/i18n/config'

export function Providers({ children }) {
  return (
    <I18nextProvider i18n={i18n}>
      <QueryClientProvider client={queryClient}>
        {/* ... 其他 providers */}
        {children}
      </QueryClientProvider>
    </I18nextProvider>
  )
}
```

## 需要修改的檔案清單

### 新增檔案
- `src/i18n/config.ts`
- `src/i18n/locales/zh-TW.json`
- `src/i18n/locales/en.json`
- `src/i18n/types.ts` (可選，TypeScript 類型定義)
- `src/stores/languageStore.ts`

### 修改檔案
- `package.json` (新增依賴)
- `src/app/providers.tsx` (加入 I18nextProvider)
- `src/components/layout/Header.tsx` (加入語言切換按鈕)
- `src/hooks/useMovies.ts` (queryKey 加入 language)
- `src/services/tmdb.ts` (API 函數加入 language 參數)
- `src/utils/constants.ts` (加入 TMDB_LANGUAGE_MAP)
- 所有頁面組件 (替換硬編碼文字為 `t()` 函數):
  - `src/pages/Home.tsx`
  - `src/pages/Top100.tsx`
  - `src/pages/RandomPick.tsx`
  - `src/pages/Wishlist.tsx`
  - `src/pages/Search.tsx`
  - `src/pages/NotFound.tsx`
- 所有 feature 組件:
  - `src/components/features/movie/MovieSection.tsx`
  - `src/components/features/filter/FilterPanel.tsx`
  - `src/components/features/search/SearchBar.tsx`
  - 其他包含硬編碼文字的組件

## 錯誤處理與容錯

### 1. 翻譯 Key 不存在

**i18next 預設行為：** 顯示 key 本身
**配置：** 設定 `fallbackLng: 'zh-TW'`，找不到翻譯時回退到繁中

### 2. API 請求失敗

使用 React Query 內建錯誤處理：
```typescript
const { data, error } = useMovies('popular')
if (error) return <div>{t('errors.loadFailed')}</div>
```

### 3. 語言切換期間的 UX

使用 `keepPreviousData: true`，切換時先顯示舊資料，避免閃爍的 loading 狀態。

## 測試策略

### 單元測試

```typescript
// languageStore.test.ts
describe('languageStore', () => {
  it('should default to zh-TW')
  it('should update language and localStorage')
  it('should sync with i18next')
})

// useMovies.test.ts
describe('useMovies with i18n', () => {
  it('should include language in queryKey')
  it('should refetch when language changes')
})
```

### 手動驗證步驟

完整測試流程：
1. ✅ 打開網站，確認預設為繁中
2. ✅ 點擊語言切換下拉選單，選擇 English
3. ✅ 確認 UI 文字（按鈕、導航、標題等）切換為英文
4. ✅ 確認電影標題、簡介也變成英文
5. ✅ 重新整理頁面，確認語言設定被保留（localStorage 生效）
6. ✅ 切換回繁中，確認快取生效（不需要 loading，因為 React Query 保留了快取）
7. ✅ 檢查 localStorage 中的 `language` 值是否正確
8. ✅ 檢查瀏覽器 DevTools Network，確認 TMDB API 請求帶了正確的 `language` 參數

## 實作注意事項

1. **逐步替換** - 先完成架構和基礎設定，再逐頁替換硬編碼文字，避免一次改動過大
2. **翻譯品質** - 英文翻譯要符合母語者習慣，避免直譯
3. **一致性** - 確保兩個語言的翻譯檔案結構完全一致
4. **類型安全** (可選) - 可使用 `i18next-typescript` 生成類型定義，避免 typo
5. **測試覆蓋** - 確保語言切換後所有頁面都正確顯示

## 未來擴充可能性

如果需要進一步增強 i18n 功能：
- 加入第三種語言（如簡體中文）
- 瀏覽器自動偵測語言（首次訪問時）
- 複數形式處理（pluralization）
- 日期/時間格式化（使用 `date-fns` 配合 i18n）
- 動態載入翻譯檔案（code splitting）

## 預期成果

實作完成後：
- ✅ 使用者可在 Header 輕鬆切換語言
- ✅ 所有 UI 文字即時切換
- ✅ 電影資料（標題、簡介）根據語言顯示不同版本
- ✅ 語言偏好持久化，重新整理後保留
- ✅ 展現業界標準的 i18n 實踐能力
- ✅ 專案更國際化，適合作為 Portfolio 展示
